<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>飞书仪表盘-记录总数+字段数值组合图（可配置版）</title>
    <!-- 引入ECharts -->
    <script src="https://cdn.jsdelivr.net/npm/echarts@5.4.3/dist/echarts.min.js"></script>
    <!-- 飞书官方SDK（必须，提供鉴权和跨域请求能力） -->
    <script src="https://lf6-cdn-tos.bytecdntp.com/cdn/expire-1-year/im/feishu-plugin-sdk/1.0.0/feishu-plugin-sdk.min.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body, html { width: 100%; height: 100%; min-height: 500px; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; }
        /* 配置面板样式 */
        .config-panel { position: absolute; top: 0; left: 0; right: 0; padding: 16px; background: #f5f7fa; border-bottom: 1px solid #e8e8e8; z-index: 10; display: flex; flex-wrap: wrap; gap: 12px; align-items: center; }
        .config-item { display: flex; flex-direction: column; gap: 4px; min-width: 200px; }
        .config-item label { font-size: 12px; color: #666; font-weight: 500; }
        .config-item input { padding: 8px 12px; border: 1px solid #d9d9d9; border-radius: 4px; outline: none; font-size: 14px; }
        .config-item input:focus { border-color: #1890ff; }
        .btn { padding: 8px 16px; border: none; border-radius: 4px; cursor: pointer; font-size: 14px; }
        .btn-save { background: #1890ff; color: #fff; }
        .btn-refresh { background: #f5f7fa; color: #333; border: 1px solid #d9d9d9; }
        /* 图表容器样式 */
        .chart-container { position: absolute; top: 80px; left: 0; right: 0; bottom: 0; }
        #chart { width: 100%; height: 100%; }
        /* 提示样式 */
        .tip { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); font-size: 16px; color: #666; }
        .error-tip { color: #f5222d; display: none; }
    </style>
</head>
<body>
    <!-- 配置面板：用户自主配置参数，不写死 -->
    <div class="config-panel">
        <div class="config-item">
            <label>多维表格BaseID</label>
            <input type="text" id="baseId" placeholder="如bascnxxxxxxxxxxxxxxxx">
        </div>
        <div class="config-item">
            <label>数据表TableID</label>
            <input type="text" id="tableId" placeholder="如tblxxxxxxxxxxxxxxxx">
        </div>
        <div class="config-item">
            <label>要统计的字段名/ID</label>
            <input type="text" id="fieldKey" placeholder="如销售额/fld123456" value="销售额">
        </div>
        <button class="btn btn-save" onclick="saveConfig()">保存配置</button>
        <button class="btn btn-refresh" onclick="initChart()">刷新图表</button>
    </div>

    <!-- 图表容器 -->
    <div class="chart-container">
        <div id="chart"></div>
        <div class="tip" id="loading">请配置参数并点击保存/刷新</div>
        <div class="tip error-tip" id="error"></div>
    </div>

    <script>
        const FEISHU_API = "https://open.feishu.cn/open-apis"; // 固定飞书API地址
        let chartInstance = null;

        // 1. 工具函数：显示提示/错误
        function showTip(type, msg = "") {
            document.getElementById("loading").style.display = "none";
            document.getElementById("error").style.display = "none";
            if (type === "loading") {
                document.getElementById("loading").innerText = msg;
                document.getElementById("loading").style.display = "block";
            }
            if (type === "error") {
                document.getElementById("error").innerText = msg;
                document.getElementById("error").style.display = "block";
            }
        }

        // 2. 工具函数：保存配置到本地（刷新插件不丢失）
        function saveConfig() {
            const baseId = document.getElementById("baseId").value.trim();
            const tableId = document.getElementById("tableId").value.trim();
            const fieldKey = document.getElementById("fieldKey").value.trim();
            // 验证参数
            if (!baseId || !tableId || !fieldKey) {
                showTip("error", "请填写完整配置参数，不能为空！");
                return;
            }
            // 保存到本地缓存
            localStorage.setItem("feishu_chart_config", JSON.stringify({ baseId, tableId, fieldKey }));
            showTip("loading", "配置已保存，正在拉取数据...");
            // 立即刷新图表
            initChart();
        }

        // 3. 拉取表格数据（核心：用飞书lark.request，无跨域，自动鉴权）
        async function fetchTableData() {
            // 从本地获取配置参数
            const config = JSON.parse(localStorage.getItem("feishu_chart_config") || "{}");
            if (!config.baseId || !config.tableId || !config.fieldKey) {
                showTip("error", "请先填写并保存配置参数！");
                return null;
            }
            const { baseId, tableId, fieldKey } = config;

            return new Promise((resolve, reject) => {
                let allRecords = [];
                let pageToken = "";

                // 递归分页拉取所有数据（飞书API默认每页100条）
                function fetchPage() {
                    lark.request({
                        url: `${FEISHU_API}/bitable/v1/apps/${baseId}/tables/${tableId}/records`,
                        method: "GET",
                        params: { page_size: 100, page_token: pageToken },
                        success: (res) => {
                            if (res.code !== 0) {
                                reject(new Error(`拉取数据失败：${res.msg || '未知错误'}`));
                                return;
                            }
                            allRecords = [...allRecords, ...res.data.items];
                            pageToken = res.data.page_token || "";
                            // 有下一页则继续拉取，无则处理数据
                            if (pageToken) {
                                fetchPage();
                            } else {
                                // 前端自主统计：记录总数 + 字段数值
                                const totalCount = allRecords.length;
                                const fieldValues = allRecords.map(item => item.fields[fieldKey] || 0);
                                const xData = fieldValues.map((_, i) => `数据${i+1}`);
                                resolve({
                                    total: Array(fieldValues.length).fill(totalCount),
                                    fieldValues: fieldValues,
                                    xData: xData,
                                    fieldName: fieldKey
                                });
                            }
                        },
                        fail: (err) => {
                            reject(new Error(`网络请求失败：${err.errMsg || JSON.stringify(err)}`));
                        }
                    });
                }

                fetchPage();
            });
        }

        // 4. 初始化ECharts组合图（记录总数+字段数值，双Y轴，适配飞书主题）
        function initECharts(data) {
            if (!data) return;
            const { total, fieldValues, xData, fieldName } = data;
            // 初始化图表
            if (!chartInstance) {
                chartInstance = echarts.init(document.getElementById("chart"));
                // 窗口自适应
                window.addEventListener("resize", () => chartInstance && chartInstance.resize());
                // 适配飞书主题切换
                window.lark?.on("themeChange", (theme) => {
                    chartInstance.setTheme(theme === "dark" ? "dark" : "light");
                });
            }
            // 组合图配置（柱状图=记录总数，折线图=字段数值）
            const option = {
                title: { text: `记录总数 + [${fieldName}] 数值组合图`, left: "center", top: 10 },
                tooltip: { trigger: "axis", crossStyle: { color: "#1890ff" } },
                legend: { data: ["记录总数", fieldName], top: 40 },
                xAxis: { type: "category", data: xData, axisLabel: { rotate: 30 } },
                yAxis: [
                    { type: "value", name: "记录总数", min: 0, axisLine: { color: "#1890ff" } }, // 左Y轴：总数
                    { type: "value", name: fieldName, min: 0, position: "right", axisLine: { color: "#f5222d" } } // 右Y轴：字段数值
                ],
                series: [
                    {
                        name: "记录总数",
                        type: "bar",
                        yAxisIndex: 0,
                        data: total,
                        itemStyle: { color: "#1890ff" },
                        barWidth: "30%"
                    },
                    {
                        name: fieldName,
                        type: "line",
                        yAxisIndex: 1,
                        data: fieldValues,
                        symbol: "circle",
                        symbolSize: 6,
                        itemStyle: { color: "#f5222d" }
                    }
                ]
            };
            chartInstance.setOption(option);
            showTip("none");
            // 适配飞书默认主题
            chartInstance.setTheme(window.lark?.getTheme() || "light");
        }

        // 5. 核心入口：初始化图表（拉取数据+渲染）
        async function initChart() {
            // 先判断飞书SDK是否初始化完成
            if (!window.lark) {
                showTip("error", "飞书插件SDK初始化失败，请刷新仪表盘！");
                return;
            }
            showTip("loading", "正在拉取表格数据...");
            try {
                // 拉取数据
                const data = await fetchTableData();
                if (!data) return;
                // 渲染组合图
                initECharts(data);
            } catch (err) {
                showTip("error", err.message);
            }
        }

        // 6. 页面加载：恢复本地配置 + 飞书插件生命周期适配
        window.onload = () => {
            // 恢复本地保存的配置
            const config = JSON.parse(localStorage.getItem("feishu_chart_config") || "{}");
            if (config.baseId) document.getElementById("baseId").value = config.baseId;
            if (config.tableId) document.getElementById("tableId").value = config.tableId;
            if (config.fieldKey) document.getElementById("fieldKey").value = config.fieldKey;

            // 飞书插件核心生命周期：挂载完成后初始化
            window.lark?.on("mount", () => {
                console.log("飞书插件挂载成功");
            });
            // 飞书仪表盘筛选器变化时，自动刷新图表
            window.lark?.on("update", () => {
                showTip("loading", "筛选器变化，重新拉取数据...");
                initChart();
            });
        };
    </script>
</body>
</html>