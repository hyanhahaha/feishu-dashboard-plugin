<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>飞书仪表盘-记录总数+字段数值组合图（可配置版）</title>
    <!-- 引入ECharts -->
    <script src="https://cdn.jsdelivr.net/npm/echarts@5.4.3/dist/echarts.min.js"></script>
    <!-- 引入axios -->
    <script src="https://cdn.jsdelivr.net/npm/axios@1.6.2/dist/axios.min.js"></script>
    <!-- 飞书SDK -->
    <script src="https://lf6-cdn-tos.bytecdntp.com/cdn/expire-1-year/im/feishu-plugin-sdk/1.0.0/feishu-plugin-sdk.min.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body, html { width: 100%; height: 100%; min-height: 500px; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; }
        /* 配置面板样式 */
        .config-panel { position: absolute; top: 0; left: 0; right: 0; padding: 16px; background: #f5f7fa; border-bottom: 1px solid #e8e8e8; z-index: 10; display: flex; flex-wrap: wrap; gap: 12px; align-items: center; }
        .config-item { display: flex; flex-direction: column; gap: 4px; min-width: 200px; }
        .config-item label { font-size: 12px; color: #666; font-weight: 500; }
        .config-item input { padding: 8px 12px; border: 1px solid #d9d9d9; border-radius: 4px; outline: none; font-size: 14px; }
        .config-item input:focus { border-color: #1890ff; }
        .btn { padding: 8px 16px; border: none; border-radius: 4px; cursor: pointer; font-size: 14px; }
        .btn-save { background: #1890ff; color: #fff; }
        .btn-refresh { background: #f5f7fa; color: #333; border: 1px solid #d9d9d9; }
        /* 图表容器样式 */
        .chart-container { position: absolute; top: 80px; left: 0; right: 0; bottom: 0; }
        #chart { width: 100%; height: 100%; }
        /* 提示样式 */
        .tip { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); font-size: 16px; color: #666; }
        .error-tip { color: #f5222d; display: none; }
    </style>
</head>
<body>
    <!-- 配置面板：用户自主配置参数，不写死 -->
    <div class="config-panel">
        <div class="config-item">
            <label>多维表格BaseID</label>
            <input type="text" id="baseId" placeholder="如bascnxxxxxxxxxxxxxxxx">
        </div>
        <div class="config-item">
            <label>数据表TableID</label>
            <input type="text" id="tableId" placeholder="如tblxxxxxxxxxxxxxxxx">
        </div>
        <div class="config-item">
            <label>要统计的字段名/ID</label>
            <input type="text" id="fieldKey" placeholder="如销售额/fld123456" value="销售额">
        </div>
        <button class="btn btn-save" onclick="saveConfig()">保存配置</button>
        <button class="btn btn-refresh" onclick="initChart()">刷新图表</button>
    </div>

    <!-- 图表容器 -->
    <div class="chart-container">
        <div id="chart"></div>
        <div class="tip" id="loading">请配置参数并点击保存/刷新</div>
        <div class="tip error-tip" id="error"></div>
    </div>

    <script>
        // ########## 仅需替换这2个固定参数（飞书应用的，不用改） ##########
        const FEISHU_CONFIG = {
            appId: "cli_a9f36ffdbaba5cb3", // 替换为你的AppID，保留双引号
            appSecret: "bE3N5zH6AgNoP5EhD8XpwhareuFFWcJJ" // 替换为你的AppSecret，保留双引号
        };
        // #################################################################
        const FEISHU_API = "https://open.feishu.cn/open-apis"; // 固定飞书API地址
        let chartInstance = null;

        // 1. 工具函数：显示提示/错误
        function showTip(type, msg = "") {
            document.getElementById("loading").style.display = "none";
            document.getElementById("error").style.display = "none";
            if (type === "loading") {
                document.getElementById("loading").innerText = msg;
                document.getElementById("loading").style.display = "block";
            }
            if (type === "error") {
                document.getElementById("error").innerText = msg;
                document.getElementById("error").style.display = "block";
            }
        }

        // 2. 工具函数：保存配置到本地（刷新插件不丢失）
        function saveConfig() {
            const baseId = document.getElementById("baseId").value.trim();
            const tableId = document.getElementById("tableId").value.trim();
            const fieldKey = document.getElementById("fieldKey").value.trim();
            // 验证参数
            if (!baseId || !tableId || !fieldKey) {
                showTip("error", "请填写完整配置参数，不能为空！");
                return;
            }
            // 保存到本地缓存
            localStorage.setItem("feishu_chart_config", JSON.stringify({ baseId, tableId, fieldKey }));
            showTip("loading", "配置已保存，正在拉取数据...");
            // 立即刷新图表
            initChart();
        }

        // 3. 获取飞书鉴权Token（缓存，避免重复请求）
        async function getFeishuToken() {
            try {
                const res = await axios.post(
                    `${FEISHU_API}/auth/v3/tenant_access_token/internal`,
                    { app_id: FEISHU_CONFIG.appId, app_secret: FEISHU_CONFIG.appSecret }
                );
                if (res.data.code !== 0) throw new Error(`鉴权失败：${res.data.msg}`);
                return res.data.tenant_access_token;
            } catch (err) {
                showTip("error", err.message);
                return null;
            }
        }

        // 4. 拉取表格数据 + 前端统计（核心：自己计算记录总数，避开飞书原生限制）
        async function fetchTableData(token) {
            // 从本地获取配置参数
            const config = JSON.parse(localStorage.getItem("feishu_chart_config") || "{}");
            if (!config.baseId || !config.tableId || !config.fieldKey) {
                showTip("error", "请先填写并保存配置参数！");
                return null;
            }
            const { baseId, tableId, fieldKey } = config;

            try {
                let allRecords = [];
                let pageToken = "";
                // 分页拉取所有数据（解决100条限制）
                do {
                    const res = await axios.get(
                        `${FEISHU_API}/bitable/v1/apps/${baseId}/tables/${tableId}/records`,
                        {
                            headers: { Authorization: `Bearer ${token}` },
                            params: { page_size: 100, page_token: pageToken }
                        }
                    );
                    if (res.data.code !== 0) throw new Error(`拉取数据失败：${res.data.msg}`);
                    allRecords = [...allRecords, ...res.data.data.items];
                    pageToken = res.data.data.page_token || "";
                } while (pageToken);

                // 核心统计：自己计算记录总数 + 提取自定义字段数值
                const totalCount = allRecords.length; // 统计记录总数（突破飞书原生限制）
                const fieldValues = allRecords.map(item => item.fields[fieldKey] || 0); // 提取自定义字段数值
                const xData = fieldValues.map((_, i) => `数据${i+1}`); // X轴类目（可后续优化为日期/姓名等维度）

                return {
                    total: Array(fieldValues.length).fill(totalCount), // 总数列，和字段数一致，方便组合展示
                    fieldValues: fieldValues,
                    xData: xData,
                    fieldName: fieldKey // 字段名，用于图表标题/图例
                };
            } catch (err) {
                showTip("error", err.message);
                return null;
            }
        }

        // 5. 初始化ECharts组合图（记录总数+字段数值，双Y轴，适配飞书主题）
        function initECharts(data) {
            if (!data) return;
            const { total, fieldValues, xData, fieldName } = data;
            // 初始化图表
            if (!chartInstance) {
                chartInstance = echarts.init(document.getElementById("chart"));
                // 窗口自适应
                window.addEventListener("resize", () => chartInstance && chartInstance.resize());
                // 适配飞书主题
                window.lark?.on("themeChange", (theme) => chartInstance.setTheme(theme));
            }
            // 组合图配置（柱状图=记录总数，折线图=字段数值）
            const option = {
                title: { text: `记录总数 + [${fieldName}] 数值组合图`, left: "center", top: 10 },
                tooltip: { trigger: "axis", crossStyle: { color: "#1890ff" } },
                legend: { data: ["记录总数", fieldName], top: 40 },
                xAxis: { type: "category", data: xData, axisLabel: { rotate: 30 } },
                yAxis: [
                    { type: "value", name: "记录总数", min: 0, axisLine: { color: "#1890ff" } }, // 左Y轴：总数
                    { type: "value", name: fieldName, min: 0, position: "right", axisLine: { color: "#f5222d" } } // 右Y轴：字段数值
                ],
                series: [
                    {
                        name: "记录总数",
                        type: "bar",
                        yAxisIndex: 0,
                        data: total,
                        itemStyle: { color: "#1890ff" },
                        barWidth: "30%"
                    },
                    {
                        name: fieldName,
                        type: "line",
                        yAxisIndex: 1,
                        data: fieldValues,
                        symbol: "circle",
                        symbolSize: 6,
                        itemStyle: { color: "#f5222d" }
                    }
                ]
            };
            chartInstance.setOption(option);
            showTip("none");
            // 适配飞书主题
            chartInstance.setTheme(window.lark?.getTheme() || "light");
        }

        // 6. 核心入口：初始化图表（拉取数据+渲染）
        async function initChart() {
            showTip("loading", "正在获取鉴权...");
            // 获取Token
            const token = await getFeishuToken();
            if (!token) return;
            // 拉取数据
            const data = await fetchTableData(token);
            if (!data) return;
            // 渲染组合图
            initECharts(data);
        }

        // 7. 页面加载：恢复本地配置 + 飞书生命周期适配
        window.onload = () => {
            // 恢复本地保存的配置
            const config = JSON.parse(localStorage.getItem("feishu_chart_config") || "{}");
            if (config.baseId) document.getElementById("baseId").value = config.baseId;
            if (config.tableId) document.getElementById("tableId").value = config.tableId;
            if (config.fieldKey) document.getElementById("fieldKey").value = config.fieldKey;
            // 飞书仪表盘生命周期：挂载/更新时触发
            window.lark?.on("mount", () => {});
            window.lark?.on("update", () => initChart()); // 筛选器变化时自动刷新
        };
    </script>
</body>
</html>